<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Expression Evaluator</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
  </head>
  <body>
    <div class="container">
      <h2>Expression Evaluator</h2>
      <input
        type="text"
        id="expression"
        placeholder="Enter expression (e.g., 2+3*4 or x*2)"
      />
      <input
        type="number"
        id="variable-value"
        placeholder="Variable value (optional)"
      />
      <button onclick="evaluateExpression()">Evaluate</button>
      <p id="result"></p>
    </div>
    <script>
      // Set result message with color based on type
      function setResultMessage(message, type) {
        const resultElem = document.getElementById("result");
        resultElem.innerText = message;
        if (type === "result") {
          resultElem.style.color = "blue";
        } else if (type === "error") {
          resultElem.style.color = "red";
        } else if (type === "processing") {
          resultElem.style.color = "gray";
        } else {
          resultElem.style.color = "";
        }
      }

      // Evaluate expression and handle variable if present
      function evaluateExpression() {
        const expr = document.getElementById("expression").value;
        const variableValue = document.getElementById("variable-value").value;
        setResultMessage("Processing...", "processing");

        let url = "/evaluation/expression";
        let body = { expression: expr };

        // If the input contains 'x', treat it as a variable expression
        if (expr.includes("x")) {
          url = "/evaluation/variable";
          body.value = variableValue ? Number(variableValue) : 0;
        }

        fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        })
          .then((response) => {
            // Check if the response is OK
            if (!response.ok) {
              return response.json().then((data) => {                
                setResultMessage(
                  "Error: " + (data.error || "Invalid input."),
                  "error"
                );
                throw new Error(data.error || "Invalid input.");
              });
            }
            return response.json();
          })
          .then((data) => {
            if (data.request_id) {
              pollResult(data.request_id);
            } else if (data.error !== undefined) {
              setResultMessage("Error: " + data.error, "error");
            } else {
              setResultMessage("Error: Invalid response from server.", "error");
            }
          })
          .catch(() => {});
      }

      // Poll for result using request ID
      function pollResult(requestId) {
        fetch("/evaluation/result/" + requestId)
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "processing") {
              setResultMessage("Processing...", "processing");
              setTimeout(() => pollResult(requestId), 500);
            } else if (data.result !== undefined) {
              setResultMessage("Result: " + data.result, "result");
            } else if (data.error !== undefined) {
              setResultMessage("Error: " + data.error, "error");
            }
          });
      }

      // Allow pressing Enter to evaluate
      document
        .getElementById("expression")
        .addEventListener("keydown", function (e) {
          if (e.key === "Enter") evaluateExpression();
        });
    </script>
  </body>
</html>
